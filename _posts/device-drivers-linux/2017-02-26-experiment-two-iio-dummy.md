---
layout: post
title:  "IIO Dummy Experiment Two: Play with IIO Events"
date:   2017-02-26
published: true
categories: linux-kernel
---

This post represents another part of the series of work related to the `iio_dummy` driver. Before you read this post, we recommend you to first read:

1. [The iio_simple_dummy Anatomy]({{ site.baseurl }}{% post_url 2017-02-26-iio-dummy-anatomy %})
2. [IIO Dummy module Experiment One: Play with iio_dummy]({{ site.baseurl }}{% post_url 2017-02-26-experiment-one-iio-dummy %})
3. [The iio_simple_dummy_event Events Anatomy]({{ site.baseurl }}{% post_url 2017-02-26-iio-dummy-events-anatomy %})

In this post, we want to accomplish the following tasks:

1. Compile the `iio_event_monitor.c` and other;
2. Running the `iio_event_monitor`;
3. Running and see some events generated by `iio_simple_dummy_event`.

Finally, for this post, I suppose you already have `iio_dummy` compiled, loaded, and with a deviced configured via configfs (again, this stuffs are explained in the recommended post).

## Command summary

## Compile IIO tools

Linux Kernel, has a directory named `tools/` that have many different tools (e.g., perf and objtool). The IIO subsystem, also have a directory in `tools/` that have some useful tools to illustrate the use of IIO in the user space. If you want to compile any program related to `iio`, you just need to type:

```bash
$ make -C tools/iio
```
<figure>
  {{ fig_img | markdownify | remove: "<p>" | remove: "</p>" }}
  <figcaption> Code 1: Compile IIO tools </figcaption>
</figure>

Take a look at the directory after the compilation:

```bash
$ ls tools/iio/
Build              iio_event_monitor.c     iio_event_monitor.o  iio_generic_buffer.c     iio_generic_buffer.o  iio_utils.h  include  lsiio.c     lsiio.o
iio_event_monitor  iio_event_monitor-in.o  iio_generic_buffer   iio_generic_buffer-in.o  iio_utils.c           iio_utils.o  lsiio    lsiio-in.o  Makefile
```
<figure>
  {{ fig_img | markdownify | remove: "<p>" | remove: "</p>" }}
  <figcaption> Code 2: IIO tools </figcaption>
</figure>

The execution of the binary is very simple, for example, you can try to execute `lsiio` tool as following:

```bash
$ ./tools/iio/lsiio 
Device 000: my_glorious_dummy_device
```
<figure>
  {{ fig_img | markdownify | remove: "<p>" | remove: "</p>" }}
  <figcaption> Code 3: lsiio  </figcaption>
</figure>

The `lsiio` tool, identify all the available devices in your system. In the case of this tutorial, we just have `my_glorious_dummy_device`.

## Running `iio_evet_monitor`

The `iio_event_monitor` it is a tool that reads the current buffer setup from sysfs and starts a short capture from the specified device [1]. If you just execute the program, you will get:

```bash
$ ./tools/iio/iio_event_monitor 
Usage: ./tools/iio/iio_event_monitor <device_name>
```
<figure>
  {{ fig_img | markdownify | remove: "<p>" | remove: "</p>" }}
  <figcaption> Code 4: iio_event_monitor usage  </figcaption>
</figure>

As you can see, the program expects an device name. Use the `lsiio` to see the device name (in our case it is `my_glorious_dummy_device`), open another terminal, and type:

```bash
$ sudo ./tools/iio/iio_event_monitor my_glorious_dummy_device
Found IIO device with name my_glorious_dummy_device with device number 0
```

You will notice that the program start, but anything interesting occurs. Do not cancel the execution, just go to the next section.

## Generating a series of events

Now that you have `iio_event_monitor` running, open another terminal and type:

```bash
 echo 0 > /sys/bus/iio/devices/iio_evgen poke_ev0
 echo 1 > /sys/bus/iio/devices/iio_evgen poke_ev0
 echo 2 > /sys/bus/iio/devices/iio_evgen poke_ev0
 echo 3 > /sys/bus/iio/devices/iio_evgen poke_ev0
```
<figure>
  {{ fig_img | markdownify | remove: "<p>" | remove: "</p>" }}
  <figcaption> Code 5: Generate events </figcaption>
</figure>

If you going back to the terminal with the `iio_event_monitor` running, you will see output similar to:

```bash
$ sudo ./tools/iio/iio_event_monitor my_glorious_dummy_device
Found IIO device with name my_glorious_dummy_device with device number 0
Event: time: 1520102773326469013, type: voltage, channel: 0, evtype: thresh, direction: rising
Event: time: 1520102776145258970, type: activity(running), channel: 0, evtype: thresh, direction: rising
Event: time: 1520102778636096750, type: activity(walking), channel: 0, evtype: thresh, direction: falling
Event: time: 1520102781584365213, type: steps, channel: 0, evtype: change
```
<figure>
  {{ fig_img | markdownify | remove: "<p>" | remove: "</p>" }}
  <figcaption> Code 6: iio_event_monitor output </figcaption>
</figure>

Try the `echo` command from Code 5 with different values, you will notice that nothing happens. The question is: why? If you read the "[The iio_simple_dummy_event Events Anatomy]({{ site.baseurl }}{% post_url 2017-02-26-iio-dummy-events-anatomy %})" you should remember the handling function explanation. There, we saw a switch case with a range of options from 0 to 3. Each option represents an event, and we making them execute here.

## References

1. `tools/iio/iio_event_monitor.c` the source code has many useful comments.
2. [The iio_simple_dummy_event Events Anatomy]({{ site.baseurl }}{% post_url 2017-02-26-iio-dummy-events-anatomy %})
